<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NutriSnap - Smart Food Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="NutriSnap">
    <meta name="description" content="Track your meals with AI-powered nutrition analysis">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
    
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #3730A3;
            --success: #10B981;
            --warning: #F59E0B;
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            position: fixed;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .app-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .camera-section {
            padding: 1.5rem;
            background: white;
            border-bottom: 8px solid var(--gray-100);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
        }

        .meal-context-selector {
            margin-bottom: 1.5rem;
        }

        .context-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .context-option {
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            user-select: none;
        }

        .context-option:active {
            transform: scale(0.95);
        }

        .context-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .context-option .icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .context-option .label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        .meal-time-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .time-option {
            padding: 0.5rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .time-option.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            user-select: none;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .photo-preview {
            margin-top: 1.5rem;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.5rem;
            overflow: hidden;
            background: var(--gray-100);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.menu-photo {
            border: 2px solid var(--warning);
        }

        .photo-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.7rem;
            padding: 0.25rem;
            text-align: center;
        }

        .photo-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 24px;
            height: 24px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .photo-count {
            background: var(--gray-100);
            padding: 0.5rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: var(--gray-600);
            margin-bottom: 1rem;
        }

        .restaurant-info {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .restaurant-info input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }

        .meals-section {
            padding: 1.5rem;
        }

        .meals-section h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--gray-900);
        }

        .meal-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .meal-context-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background: var(--gray-100);
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .meal-context-badge.restaurant {
            background: #FEF3C7;
            color: #92400E;
        }

        .meal-context-badge.self-prepared {
            background: #D1FAE5;
            color: #065F46;
        }

        .meal-time {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .meal-photos {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .meal-photo-thumb {
            width: 60px;
            height: 60px;
            border-radius: 0.375rem;
            object-fit: cover;
            flex-shrink: 0;
        }

        .meal-photo-thumb.menu {
            border: 2px solid var(--warning);
        }

        .meal-analysis {
            background: var(--gray-50);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }

        .meal-analysis h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .detected-foods {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .food-tag {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .nutrition-preview {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-top: 0.5rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--gray-600);
            text-align: center;
        }

        .notification {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-900);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        .hidden {
            display: none !important;
        }

        .sync-status {
            font-size: 0.75rem;
            color: var(--gray-600);
            text-align: center;
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: 0.25rem;
            margin-top: 1rem;
        }

        .sync-status.syncing {
            color: var(--primary);
        }

        .sync-status.error {
            color: #DC2626;
        }

        .sync-status.success {
            color: var(--success);
        }

        .sync-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.25rem;
        }

        .sync-indicator.offline {
            background-color: var(--gray-600);
        }

        .sync-indicator.syncing {
            background-color: var(--primary);
            animation: pulse 1.5s infinite;
        }

        .sync-indicator.synced {
            background-color: var(--success);
        }

        .sync-indicator.error {
            background-color: #DC2626;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            .context-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @supports (-webkit-touch-callout: none) {
            .app-container {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>🍽️ NutriSnap</h1>
            <p>Smart meal tracking & data collection</p>
        </header>

        <div class="app-content">
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-value" id="todayMeals">0</span>
                    <span class="stat-label">Today</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="weekMeals">0</span>
                    <span class="stat-label">This Week</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="dataPoints">0</span>
                    <span class="stat-label">Data Points</span>
                </div>
            </div>

            <section class="camera-section">
                <!-- Meal Context Selection -->
                <div class="meal-context-selector">
                    <h3 class="section-title">Where did you eat?</h3>
                    <div class="context-grid">
                        <div class="context-option active" data-context="self-prepared">
                            <span class="icon">🏠</span>
                            <span class="label">Self Prepared</span>
                        </div>
                        <div class="context-option" data-context="restaurant">
                            <span class="icon">🍽️</span>
                            <span class="label">Restaurant</span>
                        </div>
                        <div class="context-option" data-context="takeout">
                            <span class="icon">🥡</span>
                            <span class="label">Takeout/Delivery</span>
                        </div>
                        <div class="context-option" data-context="snack">
                            <span class="icon">🍿</span>
                            <span class="label">Snack/Other</span>
                        </div>
                    </div>
                </div>

                <!-- Meal Time Selection -->
                <div class="meal-time-selector">
                    <div class="time-option active" data-time="breakfast">🌅 Breakfast</div>
                    <div class="time-option" data-time="lunch">☀️ Lunch</div>
                    <div class="time-option" data-time="dinner">🌙 Dinner</div>
                    <div class="time-option" data-time="snack">🍪 Snack</div>
                    <div class="time-option" data-time="other">🕐 Other</div>
                </div>

                <!-- Restaurant Info (shown when restaurant is selected) -->
                <div class="restaurant-info hidden" id="restaurantInfo">
                    <label>
                        <strong>Restaurant Name</strong>
                        <input type="text" id="restaurantName" placeholder="e.g. Joe's Pizza, Chipotle, etc.">
                    </label>
                </div>

                <!-- Photo Capture Buttons -->
                <button class="btn btn-secondary" id="galleryBtn">
                    <span>🖼️</span>
                    <span>Select from Gallery</span>
                </button>
                
                <button class="btn btn-primary" id="captureBtn">
                    <span>📷</span>
                    <span>Take Photo</span>
                </button>

                <!-- Photo Preview -->
                <div class="photo-preview hidden" id="photoPreview">
                    <div class="photo-count" id="photoCount">0 photos added</div>
                    <div class="photo-grid" id="photoGrid"></div>
                    
                    <button class="btn btn-secondary hidden" id="addMenuPhotoBtn">
                        <span>📋</span>
                        <span>Add Menu Photo</span>
                    </button>
                    
                    <button class="btn btn-primary" id="saveMealBtn">
                        <span>💾</span>
                        <span>Save Meal</span>
                    </button>
                </div>
                
                <!-- Sync Status -->
                <div class="sync-status" id="syncStatus">
                    <span class="sync-indicator offline"></span>
                    <span id="syncStatusText">Offline mode - data will sync when online</span>
                </div>
            </section>

            <section class="meals-section">
                <h2>Recent Meals</h2>
                <div id="mealsList">
                    <div class="loading">
                        <span>No meals yet. Take a photo to get started!</span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <input type="file" id="photoInput" accept="image/*" capture="environment" class="hidden">
    <input type="file" id="galleryInput" accept="image/*" multiple class="hidden">

    <script>
        // Main App Class with Data Collection Focus and Database Sync
        class NutriSnap {
            constructor() {
                this.currentPhotos = [];
                this.selectedContext = 'self-prepared';
                this.selectedTime = 'breakfast';
                this.meals = [];
                this.syncQueue = [];
                this.isOnline = navigator.onLine;
                this.syncStatus = 'offline'; // 'offline', 'syncing', 'synced', 'error'
                this.apiEndpoint = 'https://api.nutrisnap.example.com/meals'; // Replace with actual API endpoint
                this.userId = this.getUserId();
                
                this.initElements();
                this.bindEvents();
                this.loadMeals();
                this.updateUI();
                this.registerServiceWorker();
                this.setupSyncListeners();
                
                // Initial sync attempt if online
                if (this.isOnline) {
                    this.syncWithServer();
                }
            }

            initElements() {
                // Photo inputs
                this.captureBtn = document.getElementById('captureBtn');
                this.galleryBtn = document.getElementById('galleryBtn');
                this.photoInput = document.getElementById('photoInput');
                this.galleryInput = document.getElementById('galleryInput');
                
                // Photo preview
                this.photoPreview = document.getElementById('photoPreview');
                this.photoGrid = document.getElementById('photoGrid');
                this.photoCount = document.getElementById('photoCount');
                this.saveMealBtn = document.getElementById('saveMealBtn');
                this.addMenuPhotoBtn = document.getElementById('addMenuPhotoBtn');
                
                // Context selectors
                this.contextOptions = document.querySelectorAll('.context-option');
                this.timeOptions = document.querySelectorAll('.time-option');
                this.restaurantInfo = document.getElementById('restaurantInfo');
                this.restaurantNameInput = document.getElementById('restaurantName');
                
                // Lists and stats
                this.mealsList = document.getElementById('mealsList');
                this.todayMealsEl = document.getElementById('todayMeals');
                this.weekMealsEl = document.getElementById('weekMeals');
                this.dataPointsEl = document.getElementById('dataPoints');
                
                // Sync status
                this.syncStatusEl = document.getElementById('syncStatus');
                this.syncStatusTextEl = document.getElementById('syncStatusText');
            }

            bindEvents() {
                // Photo capture events
                this.captureBtn.addEventListener('click', () => {
                    this.photoInput.click();
                });

                this.galleryBtn.addEventListener('click', () => {
                    this.galleryInput.click();
                });

                this.photoInput.addEventListener('change', (e) => {
                    this.handlePhotoCapture(e.target.files, 'food');
                });

                this.galleryInput.addEventListener('change', (e) => {
                    this.handlePhotoCapture(e.target.files, 'food');
                });

                // Context selection
                this.contextOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectContext(option.dataset.context);
                    });
                });

                this.timeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        this.selectTime(option.dataset.time);
                    });
                });

                // Save meal
                this.saveMealBtn.addEventListener('click', () => {
                    this.saveMeal();
                });

                // Add menu photo button
                this.addMenuPhotoBtn.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.onchange = (e) => {
                        this.handlePhotoCapture(e.target.files, 'menu');
                    };
                    input.click();
                });
            }
            
            setupSyncListeners() {
                // Listen for online/offline events
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.showNotification('🌐 Back online! Syncing data...');
                    this.syncWithServer();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus('offline');
                    this.showNotification('📴 You are offline. Data will sync when connection is restored.');
                });
                
                // Set up periodic sync (every 5 minutes when online)
                setInterval(() => {
                    if (this.isOnline && this.syncQueue.length > 0) {
                        this.syncWithServer();
                    }
                }, 5 * 60 * 1000);
            }
            
            getUserId() {
                // Get or create a unique user ID for database sync
                let userId = localStorage.getItem('nutrisnap_user_id');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('nutrisnap_user_id', userId);
                }
                return userId;
            }

            selectContext(context) {
                this.selectedContext = context;
                this.contextOptions.forEach(option => {
                    option.classList.toggle('active', option.dataset.context === context);
                });

                // Show/hide restaurant info and menu photo button
                if (context === 'restaurant') {
                    this.restaurantInfo.classList.remove('hidden');
                    if (this.currentPhotos.length > 0) {
                        this.addMenuPhotoBtn.classList.remove('hidden');
                    }
                } else {
                    this.restaurantInfo.classList.add('hidden');
                    this.addMenuPhotoBtn.classList.add('hidden');
                }
            }

            selectTime(time) {
                this.selectedTime = time;
                this.timeOptions.forEach(option => {
                    option.classList.toggle('active', option.dataset.time === time);
                });
            }

            async handlePhotoCapture(files, type = 'food') {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const photo = await this.processPhoto(file, type);
                        this.currentPhotos.push(photo);
                    }
                }
                this.updatePhotoPreview();
            }

            async processPhoto(file, type) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = new Image();
                        img.onload = async () => {
                            // Compress image for storage
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            const maxSize = 800;
                            let { width, height } = img;
                            
                            if (width > height && width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            } else if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                            
                            // Only analyze food photos, not menu photos
                            let analysis = null;
                            if (type === 'food') {
                                this.showNotification('🤖 Analyzing food...');
                                analysis = await this.analyzeFood(dataUrl);
                            }
                            
                            resolve({
                                id: Date.now() + Math.random(),
                                type: type,
                                dataUrl,
                                analysis,
                                timestamp: new Date().toISOString(),
                                metadata: {
                                    originalSize: file.size,
                                    originalName: file.name,
                                    width: width,
                                    height: height
                                }
                            });
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }

            async analyzeFood(imageData) {
                // Simulate AI analysis with multiple food detection
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // More comprehensive food database for better data collection
                const foodDatabase = [
                    { name: 'Grilled Chicken', calories: 165, protein: 31, carbs: 0, fat: 3.6 },
                    { name: 'Caesar Salad', calories: 94, protein: 5, carbs: 4, fat: 7 },
                    { name: 'Brown Rice', calories: 112, protein: 2.6, carbs: 24, fat: 0.9 },
                    { name: 'Steamed Broccoli', calories: 35, protein: 2.4, carbs: 7, fat: 0.4 },
                    { name: 'Pasta Carbonara', calories: 450, protein: 18, carbs: 52, fat: 20 },
                    { name: 'Vegetable Stir Fry', calories: 280, protein: 8, carbs: 35, fat: 12 },
                    { name: 'Greek Yogurt', calories: 100, protein: 17, carbs: 6, fat: 0.7 },
                    { name: 'Mixed Berries', calories: 60, protein: 1, carbs: 14, fat: 0.5 },
                    { name: 'Turkey Sandwich', calories: 380, protein: 25, carbs: 40, fat: 15 },
                    { name: 'Quinoa Bowl', calories: 222, protein: 8, carbs: 39, fat: 3.6 },
                    { name: 'Salmon Fillet', calories: 206, protein: 22, carbs: 0, fat: 12 },
                    { name: 'French Fries', calories: 312, protein: 3.4, carbs: 41, fat: 15 }
                ];
                
                // Simulate detecting multiple foods in the image
                const numFoods = Math.floor(Math.random() * 3) + 1;
                const detectedFoods = [];
                const usedIndices = new Set();
                
                for (let i = 0; i < numFoods; i++) {
                    let index;
                    do {
                        index = Math.floor(Math.random() * foodDatabase.length);
                    } while (usedIndices.has(index));
                    
                    usedIndices.add(index);
                    const food = foodDatabase[index];
                    
                    detectedFoods.push({
                        name: food.name,
                        confidence: Math.floor(Math.random() * 20) + 75, // 75-94% confidence
                        nutrition: {
                            calories: food.calories,
                            protein: food.protein,
                            carbs: food.carbs,
                            fat: food.fat
                        },
                        portion: this.estimatePortion()
                    });
                }
                
                // Calculate total nutrition
                const totalNutrition = detectedFoods.reduce((total, food) => {
                    const multiplier = food.portion.multiplier;
                    return {
                        calories: total.calories + (food.nutrition.calories * multiplier),
                        protein: total.protein + (food.nutrition.protein * multiplier),
                        carbs: total.carbs + (food.nutrition.carbs * multiplier),
                        fat: total.fat + (food.nutrition.fat * multiplier)
                    };
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
                
                return {
                    detectedFoods,
                    totalNutrition,
                    analysisTimestamp: new Date().toISOString(),
                    modelVersion: '1.0-beta'
                };
            }

            estimatePortion() {
                const portions = [
                    { size: 'Small', multiplier: 0.75 },
                    { size: 'Medium', multiplier: 1.0 },
                    { size: 'Large', multiplier: 1.5 }
                ];
                
                return portions[Math.floor(Math.random() * portions.length)];
            }

            updatePhotoPreview() {
                if (this.currentPhotos.length === 0) {
                    this.photoPreview.classList.add('hidden');
                    return;
                }

                this.photoPreview.classList.remove('hidden');
                this.photoCount.textContent = `${this.currentPhotos.length} photo${this.currentPhotos.length > 1 ? 's' : ''} added`;

                // Show menu photo button for restaurant meals
                if (this.selectedContext === 'restaurant' && !this.currentPhotos.some(p => p.type === 'menu')) {
                    this.addMenuPhotoBtn.classList.remove('hidden');
                }

                // Render photo grid
                this.photoGrid.innerHTML = this.currentPhotos.map((photo, index) => `
                    <div class="photo-item ${photo.type === 'menu' ? 'menu-photo' : ''}">
                        <img src="${photo.dataUrl}" alt="${photo.type} photo">
                        ${photo.type === 'menu' ? '<div class="photo-label">Menu</div>' : ''}
                        <button class="photo-remove" onclick="app.removePhoto(${index})">×</button>
                    </div>
                `).join('');
            }

            removePhoto(index) {
                this.currentPhotos.splice(index, 1);
                this.updatePhotoPreview();
            }

            saveMeal() {
                if (this.currentPhotos.length === 0) {
                    this.showNotification('⚠️ Please add at least one photo');
                    return;
                }

                const meal = {
                    id: Date.now(),
                    context: this.selectedContext,
                    time: this.selectedTime,
                    timestamp: new Date().toISOString(),
                    photos: this.currentPhotos,
                    restaurantName: this.selectedContext === 'restaurant' ? this.restaurantNameInput.value : null,
                    analysis: this.compileMealAnalysis(),
                    dataCollectionVersion: '1.0',
                    userId: this.userId,
                    syncStatus: 'pending' // 'pending', 'synced', 'error'
                };

                this.meals.unshift(meal);
                this.saveMeals();
                
                // Add to sync queue
                this.syncQueue.push(meal.id);
                this.saveToSyncQueue();
                
                // Try to sync immediately if online
                if (this.isOnline) {
                    this.syncWithServer();
                }
                
                // Reset form
                this.currentPhotos = [];
                this.restaurantNameInput.value = '';
                this.updatePhotoPreview();
                this.updateUI();
                
                this.showNotification('✅ Meal saved successfully!');
            }

            compileMealAnalysis() {
                // Compile analysis from all food photos
                const foodPhotos = this.currentPhotos.filter(p => p.type === 'food' && p.analysis);
                
                if (foodPhotos.length === 0) {
                    return null;
                }

                const allDetectedFoods = [];
                let totalNutrition = { calories: 0, protein: 0, carbs: 0, fat: 0 };

                foodPhotos.forEach(photo => {
                    if (photo.analysis && photo.analysis.detectedFoods) {
                        allDetectedFoods.push(...photo.analysis.detectedFoods);
                        
                        // Add to total nutrition
                        const nutrition = photo.analysis.totalNutrition;
                        totalNutrition.calories += nutrition.calories;
                        totalNutrition.protein += nutrition.protein;
                        totalNutrition.carbs += nutrition.carbs;
                        totalNutrition.fat += nutrition.fat;
                    }
                });

                return {
                    detectedFoods: allDetectedFoods,
                    totalNutrition,
                    photoCount: foodPhotos.length,
                    hasMenuPhoto: this.currentPhotos.some(p => p.type === 'menu')
                };
            }

            updateUI() {
                this.updateStats();
                this.renderMeals();
            }

            updateStats() {
                const today = new Date().toDateString();
                const thisWeek = new Date();
                thisWeek.setDate(thisWeek.getDate() - 7);

                const todayMeals = this.meals.filter(m => 
                    new Date(m.timestamp).toDateString() === today
                );
                
                const weekMeals = this.meals.filter(m => 
                    new Date(m.timestamp) >= thisWeek
                );

                // Calculate total data points (photos + analyses)
                const totalDataPoints = this.meals.reduce((sum, meal) => {
                    return sum + meal.photos.length + (meal.analysis ? meal.analysis.detectedFoods.length : 0);
                }, 0);

                this.todayMealsEl.textContent = todayMeals.length;
                this.weekMealsEl.textContent = weekMeals.length;
                this.dataPointsEl.textContent = totalDataPoints;
            }

            renderMeals() {
                if (this.meals.length === 0) {
                    this.mealsList.innerHTML = `
                        <div class="loading">
                            <span>No meals yet. Take a photo to get started!</span>
                        </div>
                    `;
                    return;
                }

                this.mealsList.innerHTML = this.meals.slice(0, 10).map(meal => {
                    const date = new Date(meal.timestamp);
                    const timeStr = date.toLocaleTimeString([], { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    const dateStr = date.toLocaleDateString();

                    const contextIcons = {
                        'self-prepared': '🏠',
                        'restaurant': '🍽️',
                        'takeout': '🥡',
                        'snack': '🍿'
                    };
                    
                    // Sync status indicator
                    const syncStatusIcon = meal.syncStatus === 'synced' ? '✓' : 
                                          meal.syncStatus === 'error' ? '⚠️' : 
                                          meal.syncStatus === 'syncing' ? '↻' : '⌛';

                    return `
                        <div class="meal-card">
                            <div class="meal-header">
                                <div>
                                    <span class="meal-context-badge ${meal.context}">
                                        ${contextIcons[meal.context]} ${meal.context.replace('-', ' ')}
                                    </span>
                                    ${meal.restaurantName ? `<span style="font-size: 0.875rem; margin-left: 0.5rem;">${meal.restaurantName}</span>` : ''}
                                </div>
                                <span class="meal-time">${timeStr}</span>
                            </div>
                            
                            <div class="meal-photos">
                                ${meal.photos.map(photo => `
                                    <img src="${photo.dataUrl}" class="meal-photo-thumb ${photo.type === 'menu' ? 'menu' : ''}" 
                                         alt="${photo.type} photo" title="${photo.type === 'menu' ? 'Menu' : 'Food'}">
                                `).join('')}
                            </div>
                            
                            ${meal.analysis ? `
                                <div class="meal-analysis">
                                    <h4>AI Analysis (Beta)</h4>
                                    <div class="detected-foods">
                                        ${meal.analysis.detectedFoods.map(food => `
                                            <span class="food-tag">${food.name} (${food.confidence}%)</span>
                                        `).join('')}
                                    </div>
                                    <div class="nutrition-preview">
                                        Estimated: ${Math.round(meal.analysis.totalNutrition.calories)} cal • 
                                        ${Math.round(meal.analysis.totalNutrition.protein)}g protein • 
                                        ${Math.round(meal.analysis.totalNutrition.carbs)}g carbs • 
                                        ${Math.round(meal.analysis.totalNutrition.fat)}g fat
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.5rem;">
                                ${meal.time} • ${dateStr} • ${meal.photos.length} photo${meal.photos.length > 1 ? 's' : ''}
                                ${meal.analysis && meal.analysis.hasMenuPhoto ? ' • Menu included' : ''}
                                <span style="float: right;" title="Sync status: ${meal.syncStatus}">${syncStatusIcon}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            async syncWithServer() {
                if (this.syncQueue.length === 0) {
                    this.updateSyncStatus('synced');
                    return;
                }
                
                this.updateSyncStatus('syncing');
                
                try {
                    // Process each meal in the sync queue
                    for (const mealId of [...this.syncQueue]) {
                        const meal = this.meals.find(m => m.id === mealId);
                        
                        if (!meal) {
                            // Remove from queue if meal no longer exists
                            this.syncQueue = this.syncQueue.filter(id => id !== mealId);
                            continue;
                        }
                        
                        // Update meal status to syncing
                        meal.syncStatus = 'syncing';
                        this.saveMeals();
                        this.renderMeals();
                        
                        try {
                            // Simulate API call to sync meal data
                            await this.simulateApiCall(meal);
                            
                            // Update meal status to synced
                            meal.syncStatus = 'synced';
                            
                            // Remove from sync queue
                            this.syncQueue = this.syncQueue.filter(id => id !== mealId);
                        } catch (error) {
                            console.error('Error syncing meal:', error);
                            meal.syncStatus = 'error';
                        }
                        
                        // Save changes
                        this.saveMeals();
                        this.saveToSyncQueue();
                        this.renderMeals();
                    }
                    
                    // Update sync status based on remaining queue
                    if (this.syncQueue.length === 0) {
                        this.updateSyncStatus('synced');
                    } else {
                        this.updateSyncStatus('error');
                    }
                } catch (error) {
                    console.error('Sync error:', error);
                    this.updateSyncStatus('error');
                }
            }
            
            async simulateApiCall(meal) {
                // Simulate API call with random success/failure
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
                
                // Simulate 90% success rate
                if (Math.random() > 0.1) {
                    return { success: true, id: meal.id };
                } else {
                    throw new Error('API error');
                }
            }
            
            updateSyncStatus(status) {
                this.syncStatus = status;
                
                // Update UI
                this.syncStatusEl.className = 'sync-status ' + status;
                const indicator = this.syncStatusEl.querySelector('.sync-indicator');
                if (indicator) {
                    indicator.className = 'sync-indicator ' + status;
                }
                
                // Update text
                let statusText = '';
                switch (status) {
                    case 'offline':
                        statusText = 'Offline mode - data will sync when online';
                        break;
                    case 'syncing':
                        statusText = 'Syncing data with server...';
                        break;
                    case 'synced':
                        statusText = 'All data synced with server';
                        break;
                    case 'error':
                        statusText = 'Sync error - will retry automatically';
                        break;
                }
                
                this.syncStatusTextEl.textContent = statusText;
            }

            showNotification(message) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            loadMeals() {
                try {
                    this.meals = JSON.parse(localStorage.getItem('nutrisnap_meals') || '[]');
                    this.syncQueue = JSON.parse(localStorage.getItem('nutrisnap_sync_queue') || '[]');
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.meals = [];
                    this.syncQueue = [];
                }
            }

            saveMeals() {
                localStorage.setItem('nutrisnap_meals', JSON.stringify(this.meals));
            }
            
            saveToSyncQueue() {
                localStorage.setItem('nutrisnap_sync_queue', JSON.stringify(this.syncQueue));
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(reg => {
                            console.log('Service Worker registered');
                            
                            // Register for background sync if supported
                            if ('sync' in reg) {
                                navigator.serviceWorker.ready.then(swRegistration => {
                                    return swRegistration.sync.register('nutrisnap-sync');
                                });
                            }
                        })
                        .catch(err => console.error('Service Worker registration failed:', err));
                }
            }
        }

        const app = new NutriSnap();
        
        // Make app available globally for debugging and photo removal
        window.app = app;
    </script>
</body>
</html>
